#!/bin/sh

now=`date '+%Y-%m-%d'`
epoc=`date -j -f '%Y-%m-%d %H:%M:%S' '+%s' "$now 00:00:01" |sed 's/.....$//'`

feeds_directory="$XDG_DATA_HOME/feeds"

getGroupCount() {
    count=$(rg -c --no-filename "$epoc" "$feeds_directory/$1" |tr '\n' '+' |sed 's/.$//')
    echo "$1 ($(( count )))"
}

group="$(fd . "$feeds_directory" -t d -d 1 |sort |while read -r d; do getGroupCount "$(basename $d)"; done |fzf |sed 's/ \(.*\)$//')"

if [ -z "$group" ]; then
    echo Nothing selected
    exit 0
fi

getFeedCount() {
    count=$(rg -c --no-filename "$epoc" "$feeds_directory/$group/$1" |tr '\n' '+' |sed 's/.$//')
    echo "$1 ($(( count )))"
}

feeds="$(fd . "$feeds_directory/$group" -t f -d 1 |sort |while read -r f; do getFeedCount "$(basename "$f")"; done)"
feed="$(printf '%s\nALL' "$feeds" |fzf |sed -E 's/ \([0-9]{1,3}\)//')"

if [ -z "$feed" ]; then
    echo Nothing selected
    exit 0
fi

if [ "$feed" = 'ALL' ]; then
    feed_path="/tmp/$(random_hash)"
    cat "$feeds_directory/$group"/* |sort -r >"$feed_path"
    sfp "$feed_path"
else
    sfp "$feeds_directory/$group/$feed"
fi

